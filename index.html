<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>사이클링 주행 기록 분석</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="reset.css">
  <link rel="stylesheet" href="cycle.css">
</head>

<body>
  <header>
    <div>
      <h1>사이클링 주행 기록 분석</h1>
      <p>수정일자: 2025-08-13</p>
    </div>
    <button id="openSheetBtn" class="btn btn-info">옵션</button>
  </header>

  <div class="container">
    <div class="toolbar" style="margin-bottom:8px;">
      <input type="file" id="gpxFiles" accept=".gpx" multiple class="file-input" />
      <button id="addFilesBtn" type="button" class="btn btn-primary">파일 추가</button>
      <button id="clearFilesBtn" type="button" class="btn btn-danger">초기화</button>
    </div>

    <div id="fileChips" aria-live="polite"></div>
    <div class="muted">여러 폴더에서 연속 선택하려면 <b>파일 추가</b>를 여러 번 누르세요.</div>

    <div id="map" aria-label="활동 경로 지도"></div>
    <div class="map-toolbar">
      <button id="togglePanBtn" class="btn btn-light">지도 이동: 꺼짐</button>
      <select id="colorMode" class="btn">
        <option value="speed" selected>속도 색상</option>
        <option value="hr">심박 색상</option>
        <option value="power">파워 색상</option>
        <option value="cad">케이던스 색상</option>
        <option value="mono">단색</option>
      </select>
    </div>

    <h2 style="margin-top:16px;">파일별 요약</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th class="left">파일</th>
          <th>거리(km)</th>
          <th>경과시간</th>
          <th>이동시간</th>
          <th>평균속도(경과)</th>
          <th>평균속도(이동)</th>
          <th>최대속도</th>
          <th>평균페이스</th>
          <th>누적상승</th>
          <th>평균심박</th>
          <th>최대심박</th>
          <th>칼로리</th>
          <th>평균케이던스</th>
          <th>최대케이던스</th>
          <th>평균파워</th>
          <th>최대파워</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="card" id="cumCard" style="display:none;">
      <div class="chart-toolbar">
        <label for="cumMode" class="muted">표시: </label>
        <select id="cumMode" class="btn">
          <option value="file" selected>파일별(일자+파일명)</option>
          <option value="week">주간(ISO 주)</option>
          <option value="month">월간(YYYY-MM)</option>
        </select>
      </div>
      <h3>📈 누적 이동거리</h3>
      <div class="chart-wrap">
        <canvas id="cumChart"></canvas>
      </div>
      <div class="muted" id="cumHint"></div>
    </div>

    <!-- 단일 파일 상세 그래프 (Speed / Elevation / Heart Rate) -->
    <div class="card" id="detailCard" style="display:none;">
      <h3>🏁 단일 파일 상세 그래프</h3>

      <div class="chart-wrap" style="margin-top: 15px;">
        <h4 style="margin:0 0 6px;font-size:14px;">Speed (km/h)</h4>
        <canvas id="speedDistChart"></canvas>
      </div>

      <div class="chart-wrap" style="margin-top:25px;">
        <h4 style="margin:0 0 6px;font-size:14px;">Elevation (m)</h4>
        <canvas id="elevDistChart"></canvas>
      </div>

      <div class="chart-wrap" style="margin-top:25px; margin-bottom:20px;  ">
        <h4 style="margin:0 0 6px;font-size:14px;">Heart Rate (bpm)</h4>
        <canvas id="hrDistChart"></canvas>
      </div>
    </div>

    <div id="lapsSection" style="display:none;">
      <h2 style="margin-top:16px;">랩(스플릿)</h2>
      <table id="lapsTable">
        <thead>
          <tr>
            <th class="left">랩</th>
            <th>구간시간</th>
            <th>구간평균속도</th>
            <th>구간페이스</th>
            <th>구간상승</th>
            <th>구간평균심박</th>
            <th>구간평균케이던스</th>
            <th>구간평균파워</th>
            <th>구간칼로리</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 옵션 바텀시트 -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="grab"></div>
    <h3 id="sheetTitle" style="margin:4px 0 10px;">분석 옵션</h3>

    <div class="opt-row">
      <label>이동임계속도(m/s)
        <input type="number" id="movingThreshold" value="1.0" step="0.1" />
      </label>
      <label>랩 거리(km)
        <input type="number" id="lapDistanceKm" value="1" step="0.5" />
      </label>
    </div>

    <div class="opt-row">
      <label>고도 상승 최소(m)
        <input type="number" id="minElevGain" value="1" step="0.5" />
      </label>
      <label>속도 이상치 상한(km/h)
        <input type="number" id="maxSpeedCap" value="80" step="5" />
      </label>
    </div>

    <h4 style="margin:10px 0 0;">칼로리 옵션</h4>
    <div class="opt-row">
      <label>계산 방식
        <select id="calorieMethod">
          <option value="auto" selected>Auto(파일값→HR→MET)</option>
          <option value="hr">HR 기반(키텔식)</option>
          <option value="met">속도(MET) 기반</option>
          <option value="none">계산 안 함</option>
        </select>
      </label>
      <label>체중(kg)
        <input type="number" id="weightKg" placeholder="예: 70" step="0.1" />
      </label>
      <label>나이
        <input type="number" id="age" placeholder="예: 40" />
      </label>
      <label>성별
        <select id="sex">
          <option value="">선택</option>
          <option value="male">남</option>
          <option value="female">여</option>
        </select>
      </label>
    </div>

    <div class="opt-row">
      <label>FTP (W)
        <input id="ftpW" type="number" inputmode="numeric" min="50" max="600" step="1" placeholder="예: 250">
      </label>
      <div class="muted" style="font-size:12px;">NP/IF/TSS 계산에 사용됩니다.</div>
    </div>

    <div class="opt-row" style="align-items:center;">
      <input type="checkbox" id="useSmoothElevation" checked />
      <label for="useSmoothElevation">고도 스무딩 사용(권장)</label>
    </div>

    <div class="opt-row" style="justify-content:flex-end;">
      <button id="closeSheetBtn" class="btn btn-secondary">닫기</button>
    </div>
  </div>


  <div id="metricSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="metricSheetTitle">
    <div class="grab"></div>
    <h3 id="metricSheetTitle" style="margin:4px 0 10px;">표시할 지표 선택</h3>

    <div class="opt-row">
      <label><input type="checkbox" value="distance" checked /> 거리(km)</label>
      <label><input type="checkbox" value="elapsed" checked /> 경과시간</label>
      <label><input type="checkbox" value="moving" checked /> 이동시간</label>
      <label><input type="checkbox" value="avg_speed_elapsed" checked /> 평균속도(경과)</label>
      <label><input type="checkbox" value="avg_speed_moving" checked /> 평균속도(이동)</label>
      <label><input type="checkbox" value="max_speed" checked /> 최대속도</label>
      <label><input type="checkbox" value="avg_pace" checked /> 평균페이스</label>
    </div>

    <div class="opt-row">
      <label><input type="checkbox" value="total_ascent" checked /> 누적상승</label>
      <label><input type="checkbox" value="avg_hr" checked /> 평균심박</label>
      <label><input type="checkbox" value="max_hr" checked /> 최대심박</label>
      <label><input type="checkbox" value="calories" checked /> 칼로리</label>
      <label><input type="checkbox" value="avg_cad" checked /> 평균케이던스</label>
      <label><input type="checkbox" value="max_cad" checked /> 최대케이던스</label>
    </div>

    <div class="opt-row">
      <label><input type="checkbox" value="avg_power" checked /> 평균파워</label>
      <label><input type="checkbox" value="max_power" checked /> 최대파워</label>
      <label><input type="checkbox" value="np" checked /> NP</label>
      <label><input type="checkbox" value="if" checked /> IF</label>
      <label><input type="checkbox" value="tss" checked /> TSS</label>
    </div>

    <div class="opt-row" style="justify-content:flex-end;">
      <button id="closeMetricSheetBtn" class="btn btn-secondary">닫기</button>
    </div>
  </div>


  <div class="fabbar" role="group" aria-label="기본 작업">
    <button id="analyzeBtn" class="btn btn-primary">GPX 분석 시작</button>
    <button id="exportSummaryBtn" class="btn" disabled>주행 요약 저장</button>
    <button id="exportLapsBtn" class="btn" disabled>랩(구간) 기록 저장</button>
  </div>

  <div id="overlay" class="overlay" aria-live="polite">
    <div class="spinner"></div>
    <div><span id="progressText">처리 중…</span></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script type="module" src="./gpx-mobile-ui.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>

</body>

</html>
