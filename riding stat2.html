<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPX 다중 분석 + 지도</title>

  <!-- Leaflet (SRI 제거) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; line-height: 1.5; padding: 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input[type="number"], select { width: 8rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    th { background: #f5f5f5; }
    td.left, th.left { text-align: left; }
    .muted { color:#666; font-size: .9rem; }
    .btns { display:flex; gap:8px; margin-top:12px; }
    #map { height: 480px; margin-top: 16px; border-radius: 12px; overflow: hidden; }
    .legend {
      background: #fff; padding: 8px 10px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,.2);
      line-height: 1.2; font-size: 12px;
    }
    .legend .bar { height: 10px; width: 160px; background: linear-gradient(90deg, #3066ff, #21c36f, #ffd33d, #ff3b3b); border-radius: 4px; margin: 6px 0; }
    .legend .scale { display:flex; justify-content: space-between; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h1>GPX 다중 분석</h1>

  <div class="row">
    <input type="file" id="gpxFiles" accept=".gpx" multiple />
    <label class="muted">여러 개 파일 선택 가능</label>
  </div>

  <div class="row" style="margin-top:8px;">
    <label>이동임계속도(m/s):
      <input type="number" id="movingThreshold" value="1.0" step="0.1" />
    </label>
    <label>랩 거리(km):
      <input type="number" id="lapDistanceKm" value="1" step="0.5" />
    </label>
    <label>고도 상승 최소(m):
      <input type="number" id="minElevGain" value="1" step="0.5" />
    </label>
    <label>속도 이상치 상한(km/h):
      <input type="number" id="maxSpeedCap" value="120" step="5" />
    </label>
  </div>

  <h2>칼로리 옵션</h2>
  <div class="row">
    <label>계산 방식:
      <select id="calorieMethod">
        <option value="auto" selected>Auto(파일값 우선→HR→MET)</option>
        <option value="hr">HR 기반(키텔식)</option>
        <option value="met">속도(MET) 기반</option>
        <option value="none">계산 안 함</option>
      </select>
    </label>
    <label>체중(kg):
      <input type="number" id="weightKg" placeholder="예: 70" step="0.1" />
    </label>
    <label>나이:
      <input type="number" id="age" placeholder="예: 40" />
    </label>
    <label>성별:
      <select id="sex">
        <option value="">선택</option>
        <option value="male">남</option>
        <option value="female">여</option>
      </select>
    </label>
  </div>

  <h2>지도 시각화</h2>
  <div class="row">
    <label>색상 기준:
      <select id="colorMode">
        <option value="speed" selected>속도(km/h)</option>
        <option value="hr">심박(bpm)</option>
        <option value="mono">단색(파일별 랜덤)</option>
      </select>
    </label>
  </div>
  <div id="map"></div>

  <div class="btns">
    <button id="analyzeBtn">분석</button>
    <button id="exportSummaryBtn" disabled>요약 CSV</button>
    <button id="exportLapsBtn" disabled>랩 CSV</button>
  </div>

  <h2>파일별 요약</h2>
  <table id="summaryTable">
    <thead>
      <tr>
        <th class="left">파일</th>
        <th>포인트</th>
        <th>거리(km)</th>
        <th>경과시간</th>
        <th>이동시간</th>
        <th>평균속도(경과)</th>
        <th>평균속도(이동)</th>
        <th>최대속도</th>
        <th>평균페이스</th>
        <th>누적상승고도(m)</th>
        <th>평균심박(bpm)</th>
        <th>최대심박(bpm)</th>
        <th>칼로리(kcal)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>랩(스플릿)</h2>
  <table id="lapsTable">
    <thead>
      <tr>
        <th class="left">파일</th>
        <th>랩</th>
        <th>구간거리(km)</th>
        <th>구간시간</th>
        <th>구간평균속도</th>
        <th>구간페이스</th>
        <th>구간상승고도(m)</th>
        <th>구간평균심박(bpm)</th>
        <th>구간칼로리(kcal)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted">
    * 지도의 선색: 선택한 기준(속도/심박)에 따라 그라데이션. 단색 선택 시 파일마다 다른 단색<br/>
    * 레이어 컨트롤로 파일별 켜기/끄기 가능. 시작/종료 마커, 전체 경로 맞춤 포함
  </p>

  <!-- Leaflet JS는 반드시 내 스크립트보다 먼저 -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- 내 스크립트 -->
  <script type="module" src="./gpx-multi2.js"></script>
</body>
</html>
